<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>PDFå‘ç¥¨ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“„ PDFå‘ç¥¨ç”Ÿæˆå™¨</h1>
            <p class="subtitle">å¿«é€Ÿç”Ÿæˆä¸“ä¸šçš„PDFæ ¼å¼å‘ç¥¨</p>
        </header>

        <form id="invoiceForm" class="invoice-form" enctype="multipart/form-data">
            <!-- å¼€ç¥¨æ–¹ä¿¡æ¯ -->
            <section class="form-section">
                <h2>å¼€ç¥¨æ–¹ä¿¡æ¯ / Issuer Information</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="company_name">å…¬å¸åç§° / Company Name <span class="required">*</span></label>
                        <input type="text" id="company_name" name="company_name" required>
                    </div>
                    <div class="form-group">
                        <label for="company_address">å…¬å¸åœ°å€ / Company Address <span class="required">*</span></label>
                        <input type="text" id="company_address" name="company_address" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="company_logo">å…¬å¸Logoï¼ˆå¯é€‰ï¼‰/ Company Logo (Optional)</label>
                        <input type="file" id="company_logo" name="company_logo" accept="image/*">
                        <small class="file-hint">æ”¯æŒ PNG, JPG, JPEG, GIF, BMP, WEBP æ ¼å¼ï¼Œå»ºè®®å°ºå¯¸ 200x200px æˆ–æ›´å¤§</small>
                        <div id="logo-preview" class="image-preview"></div>
                    </div>
                </div>
            </section>

            <!-- å‘è´§æ–¹ä¿¡æ¯ -->
            <section class="form-section">
                <h2>å‘è´§æ–¹ä¿¡æ¯ / Shipper Information</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="shipper_name">å‘è´§æ–¹åç§° / Shipper Name <span class="required">*</span></label>
                        <input type="text" id="shipper_name" name="shipper_name" required>
                    </div>
                    <div class="form-group">
                        <label for="shipper_address">å‘è´§æ–¹åœ°å€ / Shipper Address <span class="required">*</span></label>
                        <input type="text" id="shipper_address" name="shipper_address" required>
                    </div>
                    <div class="form-group">
                        <label for="shipper_phone">å‘è´§æ–¹è”ç³»æ–¹å¼ / Shipper Contact <span class="required">*</span></label>
                        <input type="text" id="shipper_phone" name="shipper_phone" required>
                    </div>
                </div>
            </section>

            <!-- æ”¶è´§æ–¹/ä¹°æ–¹ä¿¡æ¯ -->
            <section class="form-section">
                <h2>æ”¶è´§æ–¹/ä¹°æ–¹ä¿¡æ¯ / Consignee/Buyer Information</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="customer_name">å…¬å¸åç§° / Company Name <span class="required">*</span></label>
                        <input type="text" id="customer_name" name="customer_name" required>
                    </div>
                    <div class="form-group">
                        <label for="plant_address">å·¥å‚åœ°å€ / Plant Address</label>
                        <input type="text" id="plant_address" name="plant_address">
                    </div>
                    <div class="form-group">
                        <label for="pin">é‚®ç¼– / Pin</label>
                        <input type="text" id="pin" name="pin">
                    </div>
                    <div class="form-group">
                        <label for="customer_address">åœ°å€ / Address</label>
                        <input type="text" id="customer_address" name="customer_address">
                    </div>
                    <div class="form-group">
                        <label for="customer_phone">è”ç³»æ–¹å¼ / Contact</label>
                        <input type="text" id="customer_phone" name="customer_phone">
                    </div>
                    <div class="form-group">
                        <label for="customer_email">å…¶ä»–ä¿¡æ¯ / Other Information</label>
                        <input type="text" id="customer_email" name="customer_email">
                    </div>
                </div>
            </section>

            <!-- è¿è¾“è¯¦æƒ… -->
            <section class="form-section">
                <h2>è¿è¾“è¯¦æƒ…ï¼ˆå¯é€‰ï¼‰/ Shipping Details (Optional)</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="port_of_shipment">èµ·è¿æ¸¯ / Port of Shipment</label>
                        <input type="text" id="port_of_shipment" name="port_of_shipment">
                    </div>
                    <div class="form-group">
                        <label for="country_of_origin">åŸäº§å›½ / Country of Origin</label>
                        <input type="text" id="country_of_origin" name="country_of_origin">
                    </div>
                    <div class="form-group">
                        <label for="port_of_destination">ç›®çš„æ¸¯ / Port of Destination</label>
                        <input type="text" id="port_of_destination" name="port_of_destination">
                    </div>
                    <div class="form-group">
                        <label for="place_of_destination">æœ€ç»ˆç›®çš„åœ° / Place of Final Destination</label>
                        <input type="text" id="place_of_destination" name="place_of_destination">
                    </div>
                    <div class="form-group">
                        <label for="shipment_term">è¿è¾“æ¡æ¬¾ / Shipment Term</label>
                        <input type="text" id="shipment_term" name="shipment_term" placeholder="e.g., EXW, FOB, CIF">
                    </div>
                </div>
            </section>

            <!-- å‘ç¥¨ä¿¡æ¯ -->
            <section class="form-section">
                <h2>å‘ç¥¨ä¿¡æ¯ / Invoice Information</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="invoice_number">Invoice No. <span class="required">*</span></label>
                        <input type="text" id="invoice_number" name="invoice_number" required>
                    </div>
                    <div class="form-group">
                        <label for="invoice_date">Date <span class="required">*</span></label>
                        <input type="date" id="invoice_date" name="invoice_date" required>
                    </div>
                    <div class="form-group">
                        <label for="po_number">Purchase Order No.</label>
                        <input type="text" id="po_number" name="po_number">
                    </div>
                    <div class="form-group">
                        <label for="currency">Currency <span class="required">*</span></label>
                        <select id="currency" name="currency" required>
                            <option value="CNY">CNY (äººæ°‘å¸)</option>
                            <option value="USD">USD (ç¾å…ƒ)</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- äº§å“æ€»ä½“æè¿° -->
            <section class="form-section">
                <h2>äº§å“æ€»ä½“æè¿°ï¼ˆå¯é€‰ï¼‰/ Product Description (Optional)</h2>
                <div class="form-group">
                    <label for="product_description">äº§å“æ€»ä½“æè¿° / Product Description</label>
                    <input type="text" id="product_description" name="product_description">
                </div>
            </section>

            <!-- å‘ç¥¨é¡¹ç›® -->
            <section class="form-section">
                <div class="section-header">
                    <h2>å‘ç¥¨é¡¹ç›® / Invoice Items</h2>
                    <button type="button" class="btn btn-secondary" id="addItemBtn">+ Add Item</button>
                </div>
                <div id="itemsContainer">
                    <div class="item-row" data-item-index="0">
                        <div class="form-group">
                            <label>äº§å“åç§° / Product Name</label>
                            <input type="text" name="item_product_name_0">
                        </div>
                        <div class="form-group">
                            <label>äº§å“ç¼–å· / Product Number</label>
                            <input type="text" name="item_product_number_0">
                        </div>
                        <div class="form-group">
                            <label>é¡¹ç›®ç¼–å· / Item Number</label>
                            <input type="text" name="item_item_number_0">
                        </div>
                        <div class="form-group">
                            <label>HSç¼–ç  / HS Code</label>
                            <input type="text" name="item_hs_code_0">
                        </div>
                        <div class="form-group">
                            <label>æè¿° / Description <span class="required">*</span></label>
                            <input type="text" name="item_description_0" required>
                        </div>
                        <div class="form-group">
                            <label>æ•°é‡ / Quantity <span class="required">*</span></label>
                            <input type="number" name="item_quantity_0" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="unit-price-label">Unit Price <span class="required">*</span></label>
                            <input type="number" name="item_unit_price_0" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="amount-label">Amount</label>
                            <input type="number" name="item_amount_0" step="0.01" min="0" readonly>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="button" class="btn btn-danger btn-small remove-item" style="display:none;">Delete</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- è´¹ç”¨ä¿¡æ¯ -->
            <section class="form-section">
                <h2>è´¹ç”¨ä¿¡æ¯ / Fee Information</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="tax_rate">ç¨ç‡ (%) / Tax Rate (%)</label>
                        <input type="number" id="tax_rate" name="tax_rate" step="0.01" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="discount">æŠ˜æ‰£é‡‘é¢ / Discount Amount</label>
                        <input type="number" id="discount" name="discount" step="0.01" min="0" value="0">
                    </div>
                </div>
            </section>

            <!-- æ”¯ä»˜ä¿¡æ¯ -->
            <section class="form-section">
                <h2>æ”¯ä»˜ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰/ Payment Information (Optional)</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="bank">é“¶è¡Œåç§° / Bank Name</label>
                        <input type="text" id="bank" name="bank">
                    </div>
                    <div class="form-group">
                        <label for="account">è´¦æˆ·å·ç  / Account Number</label>
                        <input type="text" id="account" name="account">
                    </div>
                    <div class="form-group">
                        <label for="swift">SWIFTä»£ç  / SWIFT Code</label>
                        <input type="text" id="swift" name="swift">
                    </div>
                </div>
            </section>

            <!-- å¤‡æ³¨ -->
            <section class="form-section">
                <h2>å¤‡æ³¨ / Notes</h2>
                <div class="form-group">
                    <label for="notes">å¤‡æ³¨ä¿¡æ¯ / Notes</label>
                    <textarea id="notes" name="notes" rows="3" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯..."></textarea>
                </div>
            </section>

            <!-- å›¾ç«  -->
            <section class="form-section">
                <h2>å…¬å¸å›¾ç« ï¼ˆå¯é€‰ï¼‰/ Company Stamp (Optional)</h2>
                <div class="form-group">
                    <label for="company_stamp">å›¾ç« å›¾ç‰‡ / Stamp Image</label>
                    <input type="file" id="company_stamp" name="company_stamp" accept="image/*">
                    <small class="file-hint">æ”¯æŒ PNG, JPG, JPEG, GIF, BMP, WEBP æ ¼å¼ï¼Œå»ºè®®å°ºå¯¸ 200x200px æˆ–æ›´å¤§ï¼Œå°†æ˜¾ç¤ºåœ¨å‘ç¥¨åº•éƒ¨</small>
                    <div id="stamp-preview" class="image-preview"></div>
                </div>
            </section>

            <!-- æ€»è®¡é¢„è§ˆ -->
            <section class="form-section summary-section">
                <h2>è´¹ç”¨æ€»è®¡ / Total Summary</h2>
                <div class="summary-box">
                    <div class="summary-row">
                        <span>å°è®¡ / Subtotal:</span>
                        <span id="subtotal">Â¥0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>æŠ˜æ‰£ / Discount:</span>
                        <span id="discount-display">-Â¥0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>ç¨è´¹ / Tax:</span>
                        <span id="tax-amount">Â¥0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>æ€»è®¡ / Total:</span>
                        <span id="total">Â¥0.00</span>
                    </div>
                </div>
            </section>

            <!-- æäº¤æŒ‰é’® -->
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="previewBtn">é¢„è§ˆæ€»è®¡</button>
                <button type="submit" class="btn btn-primary">ç”ŸæˆPDFå‘ç¥¨</button>
            </div>
        </form>

        <!-- æ¶ˆæ¯æç¤º -->
        <div id="message" class="message"></div>
    </div>

    <script>
        // è®¾ç½®é»˜è®¤æ—¥æœŸ
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('invoice_date').value = today;

            // åˆå§‹åŒ–é¡¹ç›®è®¡æ•°
            let itemCount = 1;
            document.getElementById('invoiceForm').setAttribute('data-item-count', itemCount);

            // æ·»åŠ é¡¹ç›®
            document.getElementById('addItemBtn').addEventListener('click', function() {
                const container = document.getElementById('itemsContainer');
                const newItem = container.firstElementChild.cloneNode(true);
                const index = itemCount;
                
                newItem.setAttribute('data-item-index', index);
                newItem.querySelector('input[name^="item_product_name"]').name = `item_product_name_${index}`;
                newItem.querySelector('input[name^="item_product_name"]').value = '';
                newItem.querySelector('input[name^="item_product_number"]').name = `item_product_number_${index}`;
                newItem.querySelector('input[name^="item_product_number"]').value = '';
                newItem.querySelector('input[name^="item_item_number"]').name = `item_item_number_${index}`;
                newItem.querySelector('input[name^="item_item_number"]').value = '';
                newItem.querySelector('input[name^="item_hs_code"]').name = `item_hs_code_${index}`;
                newItem.querySelector('input[name^="item_hs_code"]').value = '';
                newItem.querySelector('input[name^="item_description"]').name = `item_description_${index}`;
                newItem.querySelector('input[name^="item_description"]').value = '';
                newItem.querySelector('input[name^="item_quantity"]').name = `item_quantity_${index}`;
                newItem.querySelector('input[name^="item_quantity"]').value = '';
                newItem.querySelector('input[name^="item_unit_price"]').name = `item_unit_price_${index}`;
                newItem.querySelector('input[name^="item_unit_price"]').value = '';
                newItem.querySelector('input[name^="item_amount"]').name = `item_amount_${index}`;
                newItem.querySelector('input[name^="item_amount"]').value = '';
                // æ›´æ–°æ–°é¡¹ç›®çš„æ ‡ç­¾
                updateCurrencyLabels(newItem);
                newItem.querySelector('.remove-item').style.display = 'block';
                
                container.appendChild(newItem);
                itemCount++;
                document.getElementById('invoiceForm').setAttribute('data-item-count', itemCount);
                
                attachItemListeners(newItem);
            });

            // åˆ é™¤é¡¹ç›®
            document.getElementById('itemsContainer').addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-item')) {
                    const itemRow = e.target.closest('.item-row');
                    if (document.getElementById('itemsContainer').children.length > 1) {
                        itemRow.remove();
                        itemCount--;
                        document.getElementById('invoiceForm').setAttribute('data-item-count', itemCount);
                        updateSummary();
                    }
                }
            });

            // è‡ªåŠ¨è®¡ç®—é‡‘é¢
            function attachItemListeners(itemRow) {
                const quantityInput = itemRow.querySelector('input[name^="item_quantity"]');
                const priceInput = itemRow.querySelector('input[name^="item_unit_price"]');
                const amountInput = itemRow.querySelector('input[name^="item_amount"]');
                
                function calculateAmount() {
                    const qty = parseFloat(quantityInput.value) || 0;
                    const price = parseFloat(priceInput.value) || 0;
                    amountInput.value = (qty * price).toFixed(2);
                    updateSummary();
                }
                
                quantityInput.addEventListener('input', calculateAmount);
                priceInput.addEventListener('input', calculateAmount);
            }

            // ä¸ºæ‰€æœ‰é¡¹ç›®æ·»åŠ ç›‘å¬å™¨
            document.querySelectorAll('.item-row').forEach(item => {
                attachItemListeners(item);
            });

            // è·å–è´§å¸ç¬¦å·
            function getCurrencySymbol() {
                const currency = document.getElementById('currency').value;
                return currency === 'USD' ? '$' : 'Â¥';
            }
            
            // æ›´æ–°è´§å¸æ ‡ç­¾
            function updateCurrencyLabels(element = null) {
                const currency = document.getElementById('currency').value;
                const currencyText = currency === 'USD' ? 'USD' : 'CNY';
                const elements = element ? [element] : document.querySelectorAll('.item-row');
                
                elements.forEach(row => {
                    const unitPriceLabel = row.querySelector('.unit-price-label');
                    const amountLabel = row.querySelector('.amount-label');
                    if (unitPriceLabel) {
                        unitPriceLabel.innerHTML = `Unit Price (${currencyText}) <span class="required">*</span>`;
                    }
                    if (amountLabel) {
                        amountLabel.innerHTML = `Amount (${currencyText})`;
                    }
                });
            }
            
            // ç›‘å¬è´§å¸å˜åŒ–
            document.getElementById('currency').addEventListener('change', function() {
                updateCurrencyLabels();
                updateSummary();
            });
            
            // åˆå§‹åŒ–è´§å¸æ ‡ç­¾
            updateCurrencyLabels();

            // æ›´æ–°æ€»è®¡
            function updateSummary() {
                let subtotal = 0;
                document.querySelectorAll('input[name^="item_amount"]').forEach(input => {
                    subtotal += parseFloat(input.value) || 0;
                });

                const taxRate = parseFloat(document.getElementById('tax_rate').value) || 0;
                const discount = parseFloat(document.getElementById('discount').value) || 0;
                const taxAmount = subtotal * (taxRate / 100);
                const total = subtotal - discount + taxAmount;
                
                const symbol = getCurrencySymbol();

                document.getElementById('subtotal').textContent = symbol + subtotal.toFixed(2);
                document.getElementById('discount-display').textContent = '-' + symbol + discount.toFixed(2);
                document.getElementById('tax-amount').textContent = symbol + taxAmount.toFixed(2);
                document.getElementById('total').textContent = symbol + total.toFixed(2);
            }

            // ç›‘å¬ç¨ç‡å’ŒæŠ˜æ‰£å˜åŒ–
            document.getElementById('tax_rate').addEventListener('input', updateSummary);
            document.getElementById('discount').addEventListener('input', updateSummary);

            // é¢„è§ˆæ€»è®¡
            document.getElementById('previewBtn').addEventListener('click', function() {
                updateSummary();
                showMessage('æ€»è®¡å·²æ›´æ–°', 'success');
            });

            // è¡¨å•æäº¤
            document.getElementById('invoiceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                formData.append('item_count', itemCount);

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'ç”Ÿæˆä¸­...';

                // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶ä¸Šä¼ 
                const logoFile = document.getElementById('company_logo').files[0];
                const stampFile = document.getElementById('company_stamp').files[0];
                
                if (logoFile) {
                    console.log('Logo file selected:', logoFile.name, 'Size:', logoFile.size, 'Type:', logoFile.type);
                }
                if (stampFile) {
                    console.log('Stamp file selected:', stampFile.name, 'Size:', stampFile.size, 'Type:', stampFile.type);
                }

                fetch('/generate', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || `HTTP error! status: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showMessage('Invoice generated successfully! Downloading...', 'success');
                        // è‡ªåŠ¨ä¸‹è½½
                        setTimeout(() => {
                            window.location.href = data.download_url;
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }, 500);
                    } else {
                        showMessage('Generation failed: ' + (data.error || 'Unknown error'), 'error');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('Error: ' + error.message, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                });
            });

            // æ˜¾ç¤ºæ¶ˆæ¯
            function showMessage(text, type) {
                const messageDiv = document.getElementById('message');
                messageDiv.textContent = text;
                messageDiv.className = 'message ' + type;
                messageDiv.style.display = 'block';
                
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }

            // Logoå›¾ç‰‡é¢„è§ˆ
            document.getElementById('company_logo').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const preview = document.getElementById('logo-preview');
                
                if (file) {
                    if (file.size > 16 * 1024 * 1024) {
                        showMessage('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº16MBçš„å›¾ç‰‡', 'error');
                        e.target.value = '';
                        preview.innerHTML = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.innerHTML = `<img src="${e.target.result}" alt="Logoé¢„è§ˆ" style="max-width: 200px; max-height: 200px; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px;">`;
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.innerHTML = '';
                }
            });

            // å›¾ç« å›¾ç‰‡é¢„è§ˆ
            document.getElementById('company_stamp').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const preview = document.getElementById('stamp-preview');
                
                if (file) {
                    if (file.size > 16 * 1024 * 1024) {
                        showMessage('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº16MBçš„å›¾ç‰‡', 'error');
                        e.target.value = '';
                        preview.innerHTML = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.innerHTML = `<img src="${e.target.result}" alt="å›¾ç« é¢„è§ˆ" style="max-width: 200px; max-height: 200px; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px;">`;
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.innerHTML = '';
                }
            });
        });
    </script>
</body>
</html>

