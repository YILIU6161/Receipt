<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFå‘ç¥¨ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“„ PDFå‘ç¥¨ç”Ÿæˆå™¨</h1>
            <p class="subtitle">å¿«é€Ÿç”Ÿæˆä¸“ä¸šçš„PDFæ ¼å¼å‘ç¥¨</p>
        </header>

        <form id="invoiceForm" class="invoice-form" enctype="multipart/form-data">
            <!-- å…¬å¸ä¿¡æ¯ -->
            <section class="form-section">
                <h2>å¼€ç¥¨æ–¹ä¿¡æ¯</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="company_name">å…¬å¸åç§° <span class="required">*</span></label>
                        <input type="text" id="company_name" name="company_name" required>
                    </div>
                    <div class="form-group">
                        <label for="company_address">å…¬å¸åœ°å€ <span class="required">*</span></label>
                        <input type="text" id="company_address" name="company_address" required>
                    </div>
                    <div class="form-group">
                        <label for="company_phone">è”ç³»ç”µè¯</label>
                        <input type="text" id="company_phone" name="company_phone">
                    </div>
                    <div class="form-group">
                        <label for="company_email">é‚®ç®±åœ°å€</label>
                        <input type="email" id="company_email" name="company_email">
                    </div>
                    <div class="form-group full-width">
                        <label for="company_logo">å…¬å¸Logoï¼ˆå¯é€‰ï¼‰</label>
                        <input type="file" id="company_logo" name="company_logo" accept="image/*">
                        <small class="file-hint">æ”¯æŒ PNG, JPG, JPEG, GIF, BMP, WEBP æ ¼å¼ï¼Œå»ºè®®å°ºå¯¸ 200x200px æˆ–æ›´å¤§</small>
                        <div id="logo-preview" class="image-preview"></div>
                    </div>
                </div>
            </section>

            <!-- å®¢æˆ·ä¿¡æ¯ -->
            <section class="form-section">
                <h2>æ”¶ç¥¨æ–¹ä¿¡æ¯</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="customer_name">å®¢æˆ·åç§° <span class="required">*</span></label>
                        <input type="text" id="customer_name" name="customer_name" required>
                    </div>
                    <div class="form-group">
                        <label for="customer_address">å®¢æˆ·åœ°å€ <span class="required">*</span></label>
                        <input type="text" id="customer_address" name="customer_address" required>
                    </div>
                    <div class="form-group">
                        <label for="customer_phone">è”ç³»ç”µè¯</label>
                        <input type="text" id="customer_phone" name="customer_phone">
                    </div>
                    <div class="form-group">
                        <label for="customer_email">é‚®ç®±åœ°å€</label>
                        <input type="email" id="customer_email" name="customer_email">
                    </div>
                </div>
            </section>

            <!-- å‘ç¥¨ä¿¡æ¯ -->
            <section class="form-section">
                <h2>å‘ç¥¨ä¿¡æ¯</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="invoice_number">å‘ç¥¨å·ç  <span class="required">*</span></label>
                        <input type="text" id="invoice_number" name="invoice_number" required>
                    </div>
                    <div class="form-group">
                        <label for="invoice_date">å¼€ç¥¨æ—¥æœŸ <span class="required">*</span></label>
                        <input type="date" id="invoice_date" name="invoice_date" required>
                    </div>
                    <div class="form-group">
                        <label for="due_date">åˆ°æœŸæ—¥æœŸ <span class="required">*</span></label>
                        <input type="date" id="due_date" name="due_date" required>
                    </div>
                </div>
            </section>

            <!-- å‘ç¥¨é¡¹ç›® -->
            <section class="form-section">
                <div class="section-header">
                    <h2>å‘ç¥¨é¡¹ç›®</h2>
                    <button type="button" class="btn btn-secondary" id="addItemBtn">+ æ·»åŠ é¡¹ç›®</button>
                </div>
                <div id="itemsContainer">
                    <div class="item-row" data-item-index="0">
                        <div class="form-group">
                            <label>Product Number</label>
                            <input type="text" name="item_product_number_0">
                        </div>
                        <div class="form-group">
                            <label>Item Number</label>
                            <input type="text" name="item_item_number_0">
                        </div>
                        <div class="form-group">
                            <label>HS Code</label>
                            <input type="text" name="item_hs_code_0">
                        </div>
                        <div class="form-group">
                            <label>Description <span class="required">*</span></label>
                            <input type="text" name="item_description_0" required>
                        </div>
                        <div class="form-group">
                            <label>Quantity <span class="required">*</span></label>
                            <input type="number" name="item_quantity_0" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Unit Price <span class="required">*</span></label>
                            <input type="number" name="item_unit_price_0" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="number" name="item_amount_0" step="0.01" min="0" readonly>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="button" class="btn btn-danger btn-small remove-item" style="display:none;">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- è´¹ç”¨ä¿¡æ¯ -->
            <section class="form-section">
                <h2>è´¹ç”¨ä¿¡æ¯</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="tax_rate">ç¨ç‡ (%)</label>
                        <input type="number" id="tax_rate" name="tax_rate" step="0.01" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="discount">æŠ˜æ‰£é‡‘é¢</label>
                        <input type="number" id="discount" name="discount" step="0.01" min="0" value="0">
                    </div>
                </div>
            </section>

            <!-- æ”¯ä»˜ä¿¡æ¯ -->
            <section class="form-section">
                <h2>æ”¯ä»˜ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="bank">é“¶è¡Œåç§°</label>
                        <input type="text" id="bank" name="bank">
                    </div>
                    <div class="form-group">
                        <label for="account">è´¦æˆ·å·ç </label>
                        <input type="text" id="account" name="account">
                    </div>
                    <div class="form-group">
                        <label for="swift">SWIFTä»£ç </label>
                        <input type="text" id="swift" name="swift">
                    </div>
                </div>
            </section>

            <!-- å¤‡æ³¨ -->
            <section class="form-section">
                <h2>å¤‡æ³¨</h2>
                <div class="form-group">
                    <label for="notes">å¤‡æ³¨ä¿¡æ¯</label>
                    <textarea id="notes" name="notes" rows="3" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯..."></textarea>
                </div>
            </section>

            <!-- å›¾ç«  -->
            <section class="form-section">
                <h2>å…¬å¸å›¾ç« ï¼ˆå¯é€‰ï¼‰</h2>
                <div class="form-group">
                    <label for="company_stamp">å›¾ç« å›¾ç‰‡</label>
                    <input type="file" id="company_stamp" name="company_stamp" accept="image/*">
                    <small class="file-hint">æ”¯æŒ PNG, JPG, JPEG, GIF, BMP, WEBP æ ¼å¼ï¼Œå»ºè®®å°ºå¯¸ 200x200px æˆ–æ›´å¤§ï¼Œå°†æ˜¾ç¤ºåœ¨å‘ç¥¨åº•éƒ¨</small>
                    <div id="stamp-preview" class="image-preview"></div>
                </div>
            </section>

            <!-- æ€»è®¡é¢„è§ˆ -->
            <section class="form-section summary-section">
                <h2>è´¹ç”¨æ€»è®¡</h2>
                <div class="summary-box">
                    <div class="summary-row">
                        <span>å°è®¡:</span>
                        <span id="subtotal">Â¥0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>æŠ˜æ‰£:</span>
                        <span id="discount-display">-Â¥0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>ç¨è´¹:</span>
                        <span id="tax-amount">Â¥0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>æ€»è®¡:</span>
                        <span id="total">Â¥0.00</span>
                    </div>
                </div>
            </section>

            <!-- æäº¤æŒ‰é’® -->
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="previewBtn">é¢„è§ˆæ€»è®¡</button>
                <button type="submit" class="btn btn-primary">ç”ŸæˆPDFå‘ç¥¨</button>
            </div>
        </form>

        <!-- æ¶ˆæ¯æç¤º -->
        <div id="message" class="message"></div>
    </div>

    <script>
        // è®¾ç½®é»˜è®¤æ—¥æœŸ
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            const dueDateStr = dueDate.toISOString().split('T')[0];
            
            document.getElementById('invoice_date').value = today;
            document.getElementById('due_date').value = dueDateStr;

            // åˆå§‹åŒ–é¡¹ç›®è®¡æ•°
            let itemCount = 1;
            document.getElementById('invoiceForm').setAttribute('data-item-count', itemCount);

            // æ·»åŠ é¡¹ç›®
            document.getElementById('addItemBtn').addEventListener('click', function() {
                const container = document.getElementById('itemsContainer');
                const newItem = container.firstElementChild.cloneNode(true);
                const index = itemCount;
                
                newItem.setAttribute('data-item-index', index);
                newItem.querySelector('input[name^="item_product_number"]').name = `item_product_number_${index}`;
                newItem.querySelector('input[name^="item_product_number"]').value = '';
                newItem.querySelector('input[name^="item_item_number"]').name = `item_item_number_${index}`;
                newItem.querySelector('input[name^="item_item_number"]').value = '';
                newItem.querySelector('input[name^="item_hs_code"]').name = `item_hs_code_${index}`;
                newItem.querySelector('input[name^="item_hs_code"]').value = '';
                newItem.querySelector('input[name^="item_description"]').name = `item_description_${index}`;
                newItem.querySelector('input[name^="item_description"]').value = '';
                newItem.querySelector('input[name^="item_quantity"]').name = `item_quantity_${index}`;
                newItem.querySelector('input[name^="item_quantity"]').value = '';
                newItem.querySelector('input[name^="item_unit_price"]').name = `item_unit_price_${index}`;
                newItem.querySelector('input[name^="item_unit_price"]').value = '';
                newItem.querySelector('input[name^="item_amount"]').name = `item_amount_${index}`;
                newItem.querySelector('input[name^="item_amount"]').value = '';
                newItem.querySelector('.remove-item').style.display = 'block';
                
                container.appendChild(newItem);
                itemCount++;
                document.getElementById('invoiceForm').setAttribute('data-item-count', itemCount);
                
                attachItemListeners(newItem);
            });

            // åˆ é™¤é¡¹ç›®
            document.getElementById('itemsContainer').addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-item')) {
                    const itemRow = e.target.closest('.item-row');
                    if (document.getElementById('itemsContainer').children.length > 1) {
                        itemRow.remove();
                        itemCount--;
                        document.getElementById('invoiceForm').setAttribute('data-item-count', itemCount);
                        updateSummary();
                    }
                }
            });

            // è‡ªåŠ¨è®¡ç®—é‡‘é¢
            function attachItemListeners(itemRow) {
                const quantityInput = itemRow.querySelector('input[name^="item_quantity"]');
                const priceInput = itemRow.querySelector('input[name^="item_unit_price"]');
                const amountInput = itemRow.querySelector('input[name^="item_amount"]');
                
                function calculateAmount() {
                    const qty = parseFloat(quantityInput.value) || 0;
                    const price = parseFloat(priceInput.value) || 0;
                    amountInput.value = (qty * price).toFixed(2);
                    updateSummary();
                }
                
                quantityInput.addEventListener('input', calculateAmount);
                priceInput.addEventListener('input', calculateAmount);
            }

            // ä¸ºæ‰€æœ‰é¡¹ç›®æ·»åŠ ç›‘å¬å™¨
            document.querySelectorAll('.item-row').forEach(item => {
                attachItemListeners(item);
            });

            // æ›´æ–°æ€»è®¡
            function updateSummary() {
                let subtotal = 0;
                document.querySelectorAll('input[name^="item_amount"]').forEach(input => {
                    subtotal += parseFloat(input.value) || 0;
                });

                const taxRate = parseFloat(document.getElementById('tax_rate').value) || 0;
                const discount = parseFloat(document.getElementById('discount').value) || 0;
                const taxAmount = subtotal * (taxRate / 100);
                const total = subtotal - discount + taxAmount;

                document.getElementById('subtotal').textContent = 'Â¥' + subtotal.toFixed(2);
                document.getElementById('discount-display').textContent = '-Â¥' + discount.toFixed(2);
                document.getElementById('tax-amount').textContent = 'Â¥' + taxAmount.toFixed(2);
                document.getElementById('total').textContent = 'Â¥' + total.toFixed(2);
            }

            // ç›‘å¬ç¨ç‡å’ŒæŠ˜æ‰£å˜åŒ–
            document.getElementById('tax_rate').addEventListener('input', updateSummary);
            document.getElementById('discount').addEventListener('input', updateSummary);

            // é¢„è§ˆæ€»è®¡
            document.getElementById('previewBtn').addEventListener('click', function() {
                updateSummary();
                showMessage('æ€»è®¡å·²æ›´æ–°', 'success');
            });

            // è¡¨å•æäº¤
            document.getElementById('invoiceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                formData.append('item_count', itemCount);

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'ç”Ÿæˆä¸­...';

                // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶ä¸Šä¼ 
                const logoFile = document.getElementById('company_logo').files[0];
                const stampFile = document.getElementById('company_stamp').files[0];
                
                if (logoFile) {
                    console.log('Logo file selected:', logoFile.name, 'Size:', logoFile.size, 'Type:', logoFile.type);
                }
                if (stampFile) {
                    console.log('Stamp file selected:', stampFile.name, 'Size:', stampFile.size, 'Type:', stampFile.type);
                }

                fetch('/generate', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || `HTTP error! status: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showMessage('Invoice generated successfully! Downloading...', 'success');
                        // è‡ªåŠ¨ä¸‹è½½
                        setTimeout(() => {
                            window.location.href = data.download_url;
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }, 500);
                    } else {
                        showMessage('Generation failed: ' + (data.error || 'Unknown error'), 'error');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('Error: ' + error.message, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                });
            });

            // æ˜¾ç¤ºæ¶ˆæ¯
            function showMessage(text, type) {
                const messageDiv = document.getElementById('message');
                messageDiv.textContent = text;
                messageDiv.className = 'message ' + type;
                messageDiv.style.display = 'block';
                
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }

            // Logoå›¾ç‰‡é¢„è§ˆ
            document.getElementById('company_logo').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const preview = document.getElementById('logo-preview');
                
                if (file) {
                    if (file.size > 16 * 1024 * 1024) {
                        showMessage('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº16MBçš„å›¾ç‰‡', 'error');
                        e.target.value = '';
                        preview.innerHTML = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.innerHTML = `<img src="${e.target.result}" alt="Logoé¢„è§ˆ" style="max-width: 200px; max-height: 200px; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px;">`;
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.innerHTML = '';
                }
            });

            // å›¾ç« å›¾ç‰‡é¢„è§ˆ
            document.getElementById('company_stamp').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const preview = document.getElementById('stamp-preview');
                
                if (file) {
                    if (file.size > 16 * 1024 * 1024) {
                        showMessage('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº16MBçš„å›¾ç‰‡', 'error');
                        e.target.value = '';
                        preview.innerHTML = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.innerHTML = `<img src="${e.target.result}" alt="å›¾ç« é¢„è§ˆ" style="max-width: 200px; max-height: 200px; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px;">`;
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.innerHTML = '';
                }
            });
        });
    </script>
</body>
</html>

